# 血战到底 AI 项目骨架规划

## 项目概述

本项目采用 Rust + Python 混合架构，Rust 负责高性能环境模拟，Python 负责神经网络训练和强化学习算法。

---

## 目录结构

```
scai/
├── README.md                    # 项目说明文档
├── .gitignore                   # Git 忽略文件
├── LICENSE                      # 许可证
│
├── rust/                        # Rust 核心引擎
│   ├── Cargo.toml               # Rust 项目配置
│   ├── Cargo.lock               # 依赖锁定文件
│   ├── .cargo/                  # Cargo 配置
│   │   └── config.toml          # 编译优化配置
│   │
│   ├── src/                     # Rust 源代码
│   │   ├── lib.rs               # 库入口，PyO3 绑定
│   │   ├── main.rs              # 可执行文件入口（测试用）
│   │   │
│   │   ├── tile/                # 牌相关模块
│   │   │   ├── mod.rs           # 模块声明
│   │   │   ├── tile.rs          # Tile 枚举和基础操作
│   │   │   ├── wall.rs          # 牌墙（Wall）实现
│   │   │   └── hand.rs          # 手牌（Hand）实现
│   │   │
│   │   ├── game/                # 游戏逻辑模块
│   │   │   ├── mod.rs           # 模块声明
│   │   │   ├── state.rs         # 游戏状态（GameState）
│   │   │   ├── player.rs        # 玩家（Player）实现
│   │   │   ├── action.rs        # 动作（Action）定义
│   │   │   ├── rules.rs         # 血战规则实现
│   │   │   └── scoring.rs       # 结算逻辑（刮风下雨、查大叫等）
│   │   │
│   │   ├── engine/              # 游戏引擎模块
│   │   │   ├── mod.rs           # 模块声明
│   │   │   ├── environment.rs   # 环境接口（Environment trait）
│   │   │   ├── simulator.rs     # 模拟器实现
│   │   │   └── action_mask.rs   # 动作掩码生成
│   │   │
│   │   ├── ai/                  # AI 相关模块（可选）
│   │   │   ├── mod.rs           # 模块声明
│   │   │   ├── evaluator.rs     # 局面评估（用于 ISMCTS）
│   │   │   └── mcts.rs          # 蒙特卡洛树搜索（可选）
│   │   │
│   │   ├── utils/               # 工具模块
│   │   │   ├── mod.rs           # 模块声明
│   │   │   ├── bitops.rs        # 位运算工具
│   │   │   └── error.rs         # 错误类型定义
│   │   │
│   │   └── python/               # PyO3 绑定模块
│   │       ├── mod.rs           # 模块声明
│   │       ├── game_state.rs    # GameState 的 Python 绑定
│   │       ├── environment.rs   # Environment 的 Python 绑定
│   │       └── tensor.rs        # Tensor 转换工具
│   │
│   ├── tests/                   # 集成测试
│   │   ├── integration_test.rs  # 集成测试
│   │   └── game_test.rs         # 游戏逻辑测试
│   │
│   ├── benches/                 # 性能基准测试
│   │   ├── tile_bench.rs        # 牌操作性能测试
│   │   ├── win_check_bench.rs   # 胡牌判定性能测试
│   │   └── game_sim_bench.rs    # 游戏模拟性能测试
│   │
│   └── examples/                # 示例代码
│       ├── simple_game.rs       # 简单游戏示例
│       └── benchmark.rs         # 性能测试示例
│
├── python/                      # Python 训练框架
│   ├── requirements.txt         # Python 依赖
│   ├── setup.py                 # 安装脚本（用于构建 Rust 扩展）
│   ├── pyproject.toml           # Python 项目配置
│   │
│   ├── scai/                    # Python 包
│   │   ├── __init__.py          # 包初始化
│   │   │
│   │   ├── env/                 # 环境相关
│   │   │   ├── __init__.py
│   │   │   ├── mahjong_env.py   # 麻将环境封装（调用 Rust）
│   │   │   └── state_encoder.py # 状态编码器（转 Tensor）
│   │   │
│   │   ├── models/              # 神经网络模型
│   │   │   ├── __init__.py
│   │   │   ├── dual_resnet.py   # Dual-ResNet 架构
│   │   │   ├── policy_head.py   # Policy Head
│   │   │   ├── value_head.py    # Value Head
│   │   │   └── backbone.py       # ResNet Backbone
│   │   │
│   │   ├── training/            # 训练相关
│   │   │   ├── __init__.py
│   │   │   ├── ppo.py           # PPO 算法实现
│   │   │   ├── trainer.py       # 训练器
│   │   │   ├── buffer.py        # 经验回放缓冲区
│   │   │   └── evaluator.py     # 模型评估器（Elo 评分）
│   │   │
│   │   ├── selfplay/            # 自对弈相关
│   │   │   ├── __init__.py
│   │   │   ├── collector.py     # 数据收集器
│   │   │   ├── worker.py        # 工作进程（Ray worker）
│   │   │   └── oracle.py         # Oracle 引导实现
│   │   │
│   │   ├── utils/               # 工具函数
│   │   │   ├── __init__.py
│   │   │   ├── config.py        # 配置管理
│   │   │   ├── logger.py        # 日志工具
│   │   │   └── checkpoint.py    # 模型检查点管理
│   │   │
│   │   └── scripts/             # 脚本
│   │       ├── train.py         # 训练脚本
│   │       ├── evaluate.py      # 评估脚本
│   │       ├── selfplay.py      # 自对弈脚本
│   │       └── benchmark.py     # 性能测试脚本
│   │
│   ├── configs/                 # 配置文件
│   │   ├── default.yaml         # 默认配置
│   │   ├── training.yaml        # 训练配置
│   │   └── model.yaml           # 模型配置
│   │
│   ├── data/                    # 数据目录
│   │   ├── checkpoints/         # 模型检查点
│   │   ├── logs/                # 训练日志
│   │   └── trajectories/        # 轨迹数据（可选）
│   │
│   └── tests/                   # Python 测试
│       ├── test_env.py          # 环境测试
│       ├── test_model.py        # 模型测试
│       └── test_training.py     # 训练测试
│
├── docs/                        # 文档目录
│   ├── architecture.md          # 架构文档
│   ├── api.md                   # API 文档
│   ├── development.md          # 开发指南
│   └── deployment.md            # 部署指南
│
├── scripts/                     # 构建和部署脚本
│   ├── build.sh                 # 构建脚本
│   ├── test.sh                  # 测试脚本
│   └── setup_env.sh             # 环境设置脚本
│
└── .github/                     # GitHub 配置
    └── workflows/               # CI/CD
        ├── rust.yml             # Rust 测试和构建
        └── python.yml           # Python 测试

```

---

## 模块职责说明

### Rust 模块

#### `tile/` - 牌相关模块
- **tile.rs**：定义 `Tile` 枚举（万、筒、条），实现基础操作和转换
- **wall.rs**：牌墙实现，支持洗牌、抽牌、剩余牌数查询
- **hand.rs**：手牌实现，支持添加、移除、查询，胡牌判定

#### `game/` - 游戏逻辑模块
- **state.rs**：游戏状态管理，包括当前玩家、已出牌、已胡牌玩家等
- **player.rs**：玩家状态，包括手牌、定缺、副露、是否已胡等
- **action.rs**：动作定义（出牌、碰、杠、胡等）
- **rules.rs**：血战规则实现（定缺、刮风下雨、玩家离场等）
- **scoring.rs**：结算逻辑（查大叫、查花猪、退税等）

#### `engine/` - 游戏引擎模块
- **environment.rs**：定义 `Environment` trait，提供标准接口
- **simulator.rs**：游戏模拟器实现，执行游戏循环
- **action_mask.rs**：生成合法动作掩码

#### `python/` - PyO3 绑定模块
- **game_state.rs**：将 `GameState` 暴露给 Python
- **environment.rs**：将 `Environment` 暴露给 Python
- **tensor.rs**：将游戏状态转换为 NumPy 数组或 PyTorch Tensor

### Python 模块

#### `env/` - 环境相关
- **mahjong_env.py**：封装 Rust 环境，提供 Gym-like 接口
- **state_encoder.py**：将游戏状态编码为 64×4×9 的 Tensor

#### `models/` - 神经网络模型
- **dual_resnet.py**：完整的 Dual-ResNet 模型
- **backbone.py**：ResNet 骨干网络（20 层）
- **policy_head.py**：策略头（输出动作概率）
- **value_head.py**：价值头（输出期望得分）

#### `training/` - 训练相关
- **ppo.py**：PPO 算法实现
- **trainer.py**：训练循环管理
- **buffer.py**：经验回放缓冲区
- **evaluator.py**：模型评估和 Elo 评分

#### `selfplay/` - 自对弈相关
- **collector.py**：收集自对弈数据
- **worker.py**：Ray worker 实现，运行多个游戏实例
- **oracle.py**：Oracle 引导实现（训练时提供完美信息）

---

## 依赖关系

### Rust 依赖（Cargo.toml）

```toml
[package]
name = "scai-engine"
version = "0.1.0"
edition = "2021"

[dependencies]
# PyO3 绑定
pyo3 = { version = "0.20", features = ["extension-module"] }
numpy = "0.20"

# 异步运行时
tokio = { version = "1.35", features = ["full"] }

# 序列化
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# 随机数
rand = "0.8"

# 性能工具
rayon = "1.8"  # 并行计算

[dev-dependencies]
criterion = "0.5"  # 性能基准测试

[lib]
crate-type = ["cdylib", "rlib"]
```

### Python 依赖（requirements.txt）

```
# 深度学习框架
torch>=2.0.0
numpy>=1.24.0

# 分布式训练
ray[default]>=2.8.0

# 工具库
pyyaml>=6.0
tensorboard>=2.14.0
wandb>=0.15.0  # 可选：实验跟踪

# 开发工具
pytest>=7.4.0
black>=23.0.0
mypy>=1.5.0
```

---

## 开发顺序建议

### 阶段 1：Rust 核心引擎（第 1-2 周）

1. **基础数据结构**（Week 1）
   - [ ] 实现 `tile/` 模块（tile.rs, wall.rs, hand.rs）
   - [ ] 实现基础测试和性能基准测试

2. **游戏逻辑**（Week 1-2）
   - [ ] 实现 `game/` 模块（state.rs, player.rs, action.rs）
   - [ ] 实现血战规则（rules.rs）
   - [ ] 实现结算逻辑（scoring.rs）

3. **游戏引擎**（Week 2）
   - [ ] 实现 `engine/` 模块
   - [ ] 实现动作掩码生成
   - [ ] 集成测试：确保每秒可跑 1 万局

### 阶段 2：PyO3 绑定和状态编码（第 2-3 周）

1. **PyO3 绑定**（Week 2-3）
   - [ ] 实现 `python/` 模块
   - [ ] 暴露 `GameState` 和 `Environment` 给 Python
   - [ ] 实现 Tensor 转换

2. **Python 环境封装**（Week 3）
   - [ ] 实现 `env/mahjong_env.py`
   - [ ] 实现 `env/state_encoder.py`
   - [ ] 测试 Python 和 Rust 的集成

### 阶段 3：神经网络和训练框架（第 3-4 周）

1. **模型架构**（Week 3-4）
   - [ ] 实现 `models/backbone.py`
   - [ ] 实现 `models/policy_head.py` 和 `models/value_head.py`
   - [ ] 实现 `models/dual_resnet.py`

2. **训练框架**（Week 4）
   - [ ] 实现 `training/ppo.py`
   - [ ] 实现 `training/buffer.py`
   - [ ] 实现 `training/trainer.py`

### 阶段 4：自对弈和优化（第 5 周+）

1. **自对弈系统**（Week 5）
   - [ ] 实现 `selfplay/collector.py`
   - [ ] 实现 `selfplay/worker.py`（Ray 集成）
   - [ ] 实现 `selfplay/oracle.py`

2. **评估系统**（Week 5-6）
   - [ ] 实现 `training/evaluator.py`
   - [ ] 实现 Elo 评分系统

3. **优化和扩展**（Week 7+）
   - [ ] ISMCTS 搜索（可选）
   - [ ] 超参数调优
   - [ ] 性能优化

---

## 配置文件示例

### Rust: Cargo.toml（关键部分）

```toml
[profile.release]
opt-level = 3
lto = true
codegen-units = 1
```

### Python: configs/default.yaml

```yaml
# 模型配置
model:
  backbone:
    num_blocks: 20
    channels: 256
  policy_head:
    hidden_size: 512
    action_dim: 119  # 108 出牌 + 11 交互动作
  value_head:
    hidden_size: 512

# 训练配置
training:
  learning_rate: 3e-4
  batch_size: 4096
  num_epochs: 10
  clip_epsilon: 0.2
  value_coef: 0.5
  entropy_coef: 0.01

# 自对弈配置
selfplay:
  num_workers: 1000
  games_per_worker: 10
  oracle_enabled: true

# 评估配置
evaluation:
  elo_threshold: 55  # 胜率阈值（%）
  checkpoint_interval: 10000  # 每 N 次迭代保存一次
```

---

## 构建和运行

### 构建 Rust 扩展

```bash
cd rust
cargo build --release
```

### 安装 Python 包

```bash
cd python
pip install -e .
```

### 运行训练

```bash
cd python
python -m scai.scripts.train --config configs/default.yaml
```

### 运行自对弈

```bash
cd python
ray start --head  # 启动 Ray 集群
python -m scai.scripts.selfplay --config configs/default.yaml
```

---

## 测试策略

### Rust 测试

```bash
cd rust
cargo test                    # 单元测试
cargo test --release          # 发布模式测试
cargo bench                   # 性能基准测试
```

### Python 测试

```bash
cd python
pytest tests/                 # 运行所有测试
pytest tests/test_env.py      # 运行特定测试
```

---

## 下一步行动

1. **初始化项目结构**
   ```bash
   mkdir -p rust/src/{tile,game,engine,python,utils}
   mkdir -p python/scai/{env,models,training,selfplay,utils,scripts}
   ```

2. **创建基础文件**
   - Rust: `Cargo.toml`, `src/lib.rs`
   - Python: `requirements.txt`, `setup.py`, `scai/__init__.py`

3. **开始实现第一阶段**
   - 从 `tile/tile.rs` 开始
   - 逐步实现各个模块

---

## 注意事项

1. **性能优先**：Rust 代码必须经过性能基准测试，确保达到性能要求
2. **测试覆盖**：每个模块都要有充分的单元测试
3. **文档同步**：代码变更时及时更新文档
4. **版本控制**：使用语义化版本控制，重要里程碑打 tag
5. **CI/CD**：设置自动化测试和构建流程

