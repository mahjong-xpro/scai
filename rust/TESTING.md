# 测试文档

## 测试结构

### 单元测试
- **位置**: `rust/src/**/tests.rs` (模块内测试)
- **覆盖范围**:
  - 所有基本胡牌型判定
  - 边界情况处理
  - 非法输入处理
  - 各种牌型组合

### 集成测试
- **位置**: `rust/tests/`
- **文件**:
  - `scoring_test.rs` - 番数计算集成测试
  - `comprehensive_test.rs` - 全面的单元测试（边界情况、牌型组合）
  - `integration_test.rs` - 完整游戏流程测试
  - `performance_stress_test.rs` - 性能压力测试

## 运行测试

### 运行所有测试
```bash
cargo test
```

### 运行特定测试文件
```bash
cargo test --test comprehensive_test
cargo test --test integration_test
cargo test --test scoring_test
```

### 运行性能压力测试
```bash
# 性能压力测试默认被忽略，需要显式运行
cargo test --test performance_stress_test -- --ignored
```

### 运行特定测试用例
```bash
cargo test test_normal_win
cargo test test_multithreaded_win_check
```

## 测试覆盖

### 单元测试覆盖
- ✅ 所有基本胡牌型（平胡、七对、对对胡等）
- ✅ 所有特殊牌型（清一色、全带幺、金钩钓等）
- ✅ 边界情况（空手牌、单张牌、13/15 张牌）
- ✅ 非法输入处理
- ✅ 各种牌型组合

### 集成测试覆盖
- ✅ 完整游戏流程（发牌、出牌、胡牌）
- ✅ 多线程并发场景（4-8 线程）
- ✅ 番数计算完整流程
- ✅ 游戏状态管理

### 性能测试覆盖
- ✅ 单线程性能（目标：10,000+ 次/秒）
- ✅ 多线程并发性能（8 线程）
- ✅ 内存使用监控
- ✅ 长时间运行稳定性

## 测试统计

### 当前测试数量
- **单元测试**: 48+ 个
- **集成测试**: 4+ 个
- **综合测试**: 12+ 个
- **性能测试**: 4+ 个

### 测试通过率
- 所有测试均通过 ✅

## 性能基准

### 性能目标
- **胡牌判定**: < 10μs
- **番数计算**: < 1μs
- **动作掩码生成**: < 5μs
- **单线程吞吐**: >= 10,000 次/秒
- **多线程吞吐**: >= 40,000 次/秒（8 线程）

### 运行性能测试
```bash
# 使用基准测试框架
cargo bench

# 运行性能压力测试
cargo test --test performance_stress_test -- --ignored --nocapture
```

## 测试最佳实践

1. **单元测试**: 每个模块都应该有对应的单元测试
2. **集成测试**: 测试模块之间的交互
3. **性能测试**: 定期运行性能测试，防止性能退化
4. **边界测试**: 确保边界情况和非法输入得到正确处理
5. **并发测试**: 验证多线程场景下的正确性和性能

## CI/CD 集成

测试已集成到 CI/CD 流程中：
- 每次提交都会运行所有单元测试和集成测试
- 性能测试在 CI 中可选运行（使用 `--ignored` 标志）

