# Bug 和遗漏功能检查报告

## 一、已实现功能检查

### ✅ 已实现
1. **基础数据结构**：Tile, Hand, Wall, WinChecker
2. **胡牌判定**：所有牌型判定（平胡、七对、对对胡、清一色等）
3. **番数计算系统**：根数统计、基础番数映射、倍率计算
4. **动作触发番**：自摸、杠上开花、杠上炮、抢杠胡、海底捞月（部分）
5. **核心准则检查**：缺一门、过胡限制、不能吃牌
6. **血战规则**：定缺、刮风下雨、玩家离场、局末结算
7. **加杠功能**：加杠、直杠、暗杠

## 二、发现的 Bug

### Bug 1: `GameState::check_gang_kai()` 逻辑不完整
**位置**: `rust/src/game/state.rs:136-139`
**问题**: 只检查上一个动作是杠，但没有检查是否在杠后立即胡牌
**修复**: 需要结合 `is_winning` 参数判断

### Bug 2: `GameState::check_gang_pao()` 和 `check_qiang_gang()` 方法缺失
**位置**: `rust/src/game/state.rs`
**问题**: 在之前的实现中提到了这些方法，但实际代码中只有 `check_gang_kai()` 和 `check_hai_di()`
**修复**: 需要实现这两个方法

### Bug 3: `KongHandler::can_rob_kong()` 只是占位符
**位置**: `rust/src/game/kong.rs:180+`
**问题**: 方法存在但只返回 `true`，没有实际的抢杠胡判定逻辑
**修复**: 需要结合胡牌判定逻辑实现

### Bug 4: `ActionMask` 缺少 `can_pong()` 和 `can_gang()` 的实际实现
**位置**: `rust/src/engine/action_mask.rs`
**问题**: 只有 `can_win()` 和 `can_chi()`，`can_pong` 和 `can_gang` 字段存在但没有生成逻辑
**修复**: 需要实现动作掩码生成逻辑

### Bug 5: 听牌判定逻辑缺失
**位置**: `rust/src/game/player.rs`
**问题**: 有 `is_ready` 字段，但没有实际的听牌判定方法
**修复**: 需要实现 `check_ready()` 方法

## 三、遗漏的功能

### ✅ 遗漏 1: 碰牌处理逻辑（已实现）
**问题**: 
- `Action::Pong` 已定义，但没有实际的碰牌处理方法
- 缺少 `PongHandler` 或类似的处理逻辑
- 缺少检查是否可以碰牌的逻辑

**已实现**:
- ✅ `PongHandler::can_pong()` - 检查是否可以碰牌（手牌中有两张相同的牌）
- ✅ `PongHandler::pong()` - 执行碰牌操作（从手牌移除两张，添加 Triplet）
- ✅ `PongHandler::get_pongable_tile()` - 获取可以碰的牌

### ⚠️ 遗漏 2: 完整的游戏循环和动作处理（部分实现）
**问题**:
- 缺少游戏主循环
- 缺少动作处理逻辑（如何处理 Draw, Discard, Pong, Kong, Win）
- 缺少状态转换逻辑

**需要实现**:
- [ ] `GameEngine` 或 `GameLoop` 结构体
- [ ] `process_action()` 方法
- [ ] 游戏流程控制
- [ ] 动作响应顺序（胡 > 杠 > 碰 > 过）

### ✅ 遗漏 3: 动作掩码生成逻辑（已实现）
**问题**:
- `ActionMask` 结构体存在，但缺少生成逻辑
- 需要根据当前游戏状态生成可用的动作列表

**已实现**:
- ✅ `ActionMask::generate()` 方法
- ✅ 根据手牌和游戏状态生成 `can_pong`, `can_gang`, `can_win` 列表
- ⚠️ 需要优化：胡牌判定需要更精确的番数计算

### ✅ 遗漏 4: 听牌判定（已实现）
**问题**:
- 有 `is_ready` 字段，但没有判定逻辑
- 需要检查手牌是否听牌（差一张就能胡）

**已实现**:
- ✅ `ReadyChecker::check_ready()` 方法
- ✅ `ReadyChecker::is_ready()` 方法
- ✅ `Player::check_ready()` 和 `get_ready_tiles()` 方法

### ✅ 遗漏 5: 抢杠胡完整逻辑（已实现基础）
**问题**:
- `can_rob_kong()` 只是占位符
- 需要结合胡牌判定和加杠场景

**已实现**:
- ✅ `KongHandler::can_rob_kong()` - 完整的抢杠胡判定逻辑
- ⚠️ 需要完善：在加杠时检查其他玩家是否可以抢杠胡（需要在游戏引擎层面实现）

### ⚠️ 遗漏 6: 游戏状态管理（部分实现）
**问题**:
- 缺少牌墙管理
- 缺少回合管理
- 缺少动作历史记录

**已实现**:
- ✅ 回合管理逻辑（`turn`, `current_player`）
- ✅ 动作历史记录（`last_action`, `gang_history`）
- [ ] 牌墙集成到 GameState（Wall 需要集成）

### ⚠️ 遗漏 7: 点炮胡判定（部分实现）
**问题**:
- 缺少点炮胡的判定逻辑
- 需要区分自摸和点炮

**已实现**:
- ✅ 自摸判定（`check_zi_mo()`）
- ⚠️ 需要完善：点炮胡判定逻辑（需要记录点炮者信息）

## 四、需要修复的细节

### 细节 1: 杠上开花判定需要更精确
当前实现只检查上一个动作是杠，但应该检查：
- 上一个动作是杠
- 当前动作是胡牌
- 是在杠后补牌时立即胡牌

### 细节 2: 杠上炮判定需要实现
需要检查：
- 上一个动作是杠
- 当前动作是出牌
- 打出的牌被别人胡

### 细节 3: 抢杠胡判定需要实现
需要检查：
- 其他玩家正在加杠（补杠）
- 你手牌中缺这张牌就可以胡牌
- 在加杠时立即声明胡牌

### 细节 4: 动作优先级
需要明确动作优先级：
1. 胡牌（最高优先级）
2. 杠（包括直杠、加杠、暗杠）
3. 碰
4. 过

### 细节 5: 动作响应顺序
需要实现动作响应顺序：
- 当玩家出牌后，其他玩家按顺序响应（胡 > 杠 > 碰 > 过）

## 五、建议的实现顺序

1. **第一步**：实现碰牌处理逻辑（PongHandler）
2. **第二步**：实现动作掩码生成逻辑
3. **第三步**：实现听牌判定逻辑
4. **第四步**：修复动作触发番的判定逻辑
5. **第五步**：实现完整的游戏循环和动作处理
6. **第六步**：实现抢杠胡完整逻辑
7. **第七步**：集成所有功能，完善游戏流程

