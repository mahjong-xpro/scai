# 弃牌序列特征（Discard Sequence Feature）审计报告

## 问题描述

AI 的输入中必须包含"已出牌的物理顺序"。对手打牌的顺序（比如先打 9 万再打 1 万）直接暴露了其"做牌"意图。

### 为什么重要

如果只提供各家弃牌的计数（Bag of words），AI 的预测能力将止步于业余水平。例如：
- 玩家先打 9 万，再打 1 万 → 可能在做清一色（先打边张，保留中张）
- 玩家先打 5 万，再打 5 万 → 可能在做七对（打掉多余的中张）
- 玩家先打 1 万，再打 9 万 → 可能在做全带幺（保留中张，打掉边张）

### 当前实现问题

**位置**: `rust/src/python/tensor.rs:74-110`

当前实现只记录了：
- Plane 4-5: 对手1的弃牌（最近2张）
- Plane 6-7: 对手2的弃牌（最近2张）
- Plane 8-9: 对手3的弃牌（最近2张）
- Plane 10: 最近一次弃牌（全局视角）

**问题**：
- ❌ 只记录了最近2张弃牌，丢失了更早的弃牌顺序信息
- ❌ 无法识别"做牌"意图（需要更长的序列）
- ❌ 无法判断玩家是否在做清一色、七对等牌型

### 建议实现

使用 $4 \times 9 \times N$ 的 Plane 记录每个玩家的弃牌序列：
- 4 个玩家
- 9 种牌（每种花色 1-9）
- N 个时间步（记录最近 N 次弃牌）

### 实现方案

#### 方案1：使用多个平面记录序列（推荐）

为每个玩家分配多个平面，记录弃牌序列：

```
Plane 14-17: 玩家0的弃牌序列（最近4次）
Plane 18-21: 玩家1的弃牌序列（最近4次）
Plane 22-25: 玩家2的弃牌序列（最近4次）
Plane 26-29: 玩家3的弃牌序列（最近4次）
```

每个平面记录一次弃牌，按时间顺序排列（最旧的在前，最新的在后）。

#### 方案2：使用时间编码

使用一个平面记录所有弃牌，但用时间编码区分顺序：

```
Plane 14: 玩家0的弃牌（时间编码）
Plane 15: 玩家1的弃牌（时间编码）
Plane 16: 玩家2的弃牌（时间编码）
Plane 17: 玩家3的弃牌（时间编码）
```

在每个位置记录弃牌的时间戳（归一化到 [0, 1]），时间越近值越大。

#### 方案3：混合方案（最完整）

结合方案1和方案2：
- 使用多个平面记录序列（方案1）
- 同时使用时间编码（方案2）

## 推荐实现

**推荐方案1**：使用多个平面记录序列

**理由**：
1. 最直观，AI 可以直接看到弃牌序列
2. 不需要额外的解码逻辑
3. 符合用户建议的 $4 \times 9 \times N$ 格式

**实现细节**：
- 为每个玩家分配 4 个平面（记录最近 4 次弃牌）
- 总共需要 16 个平面（4 个玩家 × 4 个平面）
- 使用 Plane 14-29（当前 Plane 14-25 用于 Oracle 特征，可以调整）

## 当前平面分配

根据之前的修改：
- Plane 0-3: 自身手牌
- Plane 4-10: 弃牌（当前实现，只记录最近2张）
- Plane 11: 剩余牌数
- Plane 12: 定缺掩码
- Plane 13: 每张牌的出现次数（墙内残余牌感）
- Plane 14-25: Oracle 特征（对手手牌）
- Plane 26-29: 已碰/杠的牌
- Plane 30-33: 玩家状态
- Plane 34-37: 听牌状态
- Plane 38-41: 回合信息
- Plane 42-45: 当前玩家
- Plane 46: 最后一张牌
- Plane 47-56: Oracle 特征（牌堆余牌分布）
- Plane 57-63: 保留

## 改进建议

### 方案A：调整平面分配，添加弃牌序列

将 Plane 14-25 的 Oracle 特征向后移动，为弃牌序列腾出空间：

```
Plane 14-17: 玩家0的弃牌序列（最近4次）
Plane 18-21: 玩家1的弃牌序列（最近4次）
Plane 22-25: 玩家2的弃牌序列（最近4次）
Plane 26-29: 玩家3的弃牌序列（最近4次）
Plane 30-41: Oracle 特征（对手手牌，从 Plane 14-25 移动）
Plane 42-45: 已碰/杠的牌（从 Plane 26-29 移动）
...
```

### 方案B：在现有平面基础上扩展

保留 Plane 4-10 的当前实现，添加新的平面记录完整序列：

```
Plane 14-17: 玩家0的弃牌序列（最近4次）
Plane 18-21: 玩家1的弃牌序列（最近4次）
Plane 22-25: 玩家2的弃牌序列（最近4次）
Plane 26-29: 玩家3的弃牌序列（最近4次）
```

## 实现步骤

1. **添加弃牌序列平面**：为每个玩家分配4个平面，记录最近4次弃牌
2. **按时间顺序填充**：最旧的弃牌在第一个平面，最新的弃牌在最后一个平面
3. **更新文档**：更新 `FEATURE_ENCODING.md`

