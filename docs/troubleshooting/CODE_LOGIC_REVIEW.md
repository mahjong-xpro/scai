# ä»£ç é€»è¾‘å…¨é¢æ£€æŸ¥æŠ¥å‘Š

## æ£€æŸ¥æ—¶é—´
2026-01-07

## æ£€æŸ¥èŒƒå›´
- `python/scai/selfplay/worker.py` - æ¸¸æˆä¸»å¾ªç¯å’Œè½¨è¿¹æ”¶é›†
- æ¸¸æˆçŠ¶æ€ç®¡ç†
- å¥–åŠ±è®¡ç®—é€»è¾‘
- ç‰Œå±€å›æ”¾é€»è¾‘

---

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. **æ‘¸ç‰ŒåçŠ¶æ€æœªæ›´æ–°** âœ…
**é—®é¢˜**ï¼šæ‘¸ç‰Œåä½¿ç”¨æ—§çš„`state`å˜é‡ç”ŸæˆçŠ¶æ€å¼ é‡å’ŒåŠ¨ä½œæ©ç 
**ä¿®å¤**ï¼šåœ¨æ‘¸ç‰Œåé‡æ–°è·å–`state = engine.state`
**ä½ç½®**ï¼š`worker.py:289-298`

### 2. **å›åˆæ•°ä¸ä¸€è‡´** âœ…
**é—®é¢˜**ï¼šåŠ¨ä½œæ‰§è¡Œå‰å`state.turn`å¯èƒ½ä¸åŒï¼Œå¯¼è‡´å¼ƒç‰Œè®°å½•ä¸çŠ¶æ€ä¸åŒ¹é…
**ä¿®å¤**ï¼š
- åŠ¨ä½œæ‰§è¡Œå‰ä¿å­˜`game_turn_before_action = state.turn`
- ä¿å­˜çŠ¶æ€æ—¶åªæ˜¾ç¤ºåˆ°`game_turn_before_action`ä¹‹å‰çš„å¼ƒç‰Œ
- è®°å½•å¼ƒç‰Œæ—¶ä½¿ç”¨`game_turn_before_action`
- åŠ¨ä½œæ‰§è¡Œåæ›´æ–°çŠ¶æ€æ—¶ä½¿ç”¨`game_turn_after_action`
**ä½ç½®**ï¼š`worker.py:396-491`

### 3. **å¼ƒç‰Œæ˜¾ç¤ºé€»è¾‘** âœ…
**é—®é¢˜**ï¼šç¬¬ä¸€æ­¥å°±æ˜¾ç¤ºæ‰€æœ‰å¼ƒç‰Œ
**ä¿®å¤**ï¼š
- åŠ¨ä½œæ‰§è¡Œå‰ï¼šåªæ˜¾ç¤ºåˆ°å½“å‰å›åˆä¹‹å‰çš„å¼ƒç‰Œ
- åŠ¨ä½œæ‰§è¡Œåï¼šæ˜¾ç¤ºåˆ°å½“å‰å›åˆçš„å¼ƒç‰Œï¼ˆåŒ…å«åˆšæ‰§è¡Œçš„å¼ƒç‰Œï¼‰
**ä½ç½®**ï¼š`worker.py:398-406, 485-491`

---

## âš ï¸ æ½œåœ¨é—®é¢˜

### 1. **å·²ç¦»åœºç©å®¶å¤„ç†**
**ä½ç½®**ï¼š`worker.py:254-257`
**é—®é¢˜**ï¼šå½“ç©å®¶å·²ç¦»åœºæ—¶ï¼Œä½¿ç”¨`continue`è·³è¿‡ï¼Œä½†ä¸ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç©å®¶
**å½±å“**ï¼šå¯èƒ½å¯¼è‡´æ— é™å¾ªç¯ï¼ˆå¦‚æœ`current_player`ä¸€ç›´æŒ‡å‘å·²ç¦»åœºçš„ç©å®¶ï¼‰
**å»ºè®®**ï¼š
- æ£€æŸ¥Rustå¼•æ“æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢ç©å®¶
- å¦‚æœä¸è‡ªåŠ¨åˆ‡æ¢ï¼Œéœ€è¦æ‰‹åŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæœªç¦»åœºçš„ç©å®¶
- æˆ–è€…ä¾èµ–`engine.is_game_over()`æ¥ç»“æŸæ¸¸æˆ

**å½“å‰é€»è¾‘**ï¼š
```python
if state.is_player_out(current_player):
    continue  # è·³è¿‡ï¼Œä½†current_playerä¸ä¼šæ”¹å˜
```

**å¯èƒ½çš„ä¿®å¤**ï¼š
```python
if state.is_player_out(current_player):
    # æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸï¼ˆ3å®¶ç¦»åœºæˆ–æµå±€ï¼‰
    if engine.is_game_over():
        break
    # å¦åˆ™ç»§ç»­å¾ªç¯ï¼Œä¾èµ–å¼•æ“è‡ªåŠ¨åˆ‡æ¢ç©å®¶
    # æˆ–è€…æ‰‹åŠ¨æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæœªç¦»åœºç©å®¶
    continue
```

### 2. **æ¸¸æˆç»“æŸæ¡ä»¶æ£€æŸ¥**
**ä½ç½®**ï¼š`worker.py:231, 262-269, 284-286, 292-294`
**é—®é¢˜**ï¼šå¤šå¤„æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶ï¼Œå¯èƒ½å¯¼è‡´é‡å¤å¤„ç†
**å½“å‰é€»è¾‘**ï¼š
1. å¾ªç¯æ¡ä»¶ï¼š`while not engine.is_game_over() and turn_count < max_turns`
2. è·å–çŠ¶æ€åæ£€æŸ¥ï¼š`if remaining == 0: break`
3. æ‘¸ç‰Œåæ£€æŸ¥ï¼š`if 'WallEmpty' in error_str: break`
4. åŠ¨ä½œæ‰§è¡Œåæ£€æŸ¥ï¼š`if result.get('type') == 'won': break`

**å»ºè®®**ï¼šç»Ÿä¸€æ¸¸æˆç»“æŸå¤„ç†é€»è¾‘ï¼Œé¿å…é‡å¤ä»£ç 

### 3. **å¥–åŠ±è®¡ç®—æ—¶æœº**
**ä½ç½®**ï¼š`worker.py:530-547`
**é—®é¢˜**ï¼šå¥–åŠ±åœ¨åŠ¨ä½œæ‰§è¡Œåè®¡ç®—ï¼Œä½†ä½¿ç”¨çš„æ˜¯åŠ¨ä½œæ‰§è¡Œåçš„çŠ¶æ€
**å½“å‰é€»è¾‘**ï¼š
- åŠ¨ä½œæ‰§è¡Œå‰ï¼šä¿å­˜çŠ¶æ€ï¼ˆä¸åŒ…å«å½“å‰åŠ¨ä½œçš„å½±å“ï¼‰
- åŠ¨ä½œæ‰§è¡Œåï¼šè®¡ç®—å¥–åŠ±ï¼ˆä½¿ç”¨åŠ¨ä½œæ‰§è¡Œåçš„çŠ¶æ€ï¼‰
- è¿™å¯èƒ½å¯¼è‡´å¥–åŠ±ä¸çŠ¶æ€ä¸åŒ¹é…

**å»ºè®®**ï¼š
- å¥–åŠ±åº”è¯¥åŸºäºåŠ¨ä½œæ‰§è¡Œåçš„çŠ¶æ€
- ä½†éœ€è¦ç¡®ä¿çŠ¶æ€å’Œå¥–åŠ±çš„ä¸€è‡´æ€§

### 4. **çŠ¶æ€ä¿å­˜æ—¶æœº**
**ä½ç½®**ï¼š`worker.py:393-407`
**é—®é¢˜**ï¼šçŠ¶æ€åœ¨åŠ¨ä½œæ‰§è¡Œå‰ä¿å­˜ï¼Œä½†å¥–åŠ±åœ¨åŠ¨ä½œæ‰§è¡Œåè®¡ç®—
**å½“å‰é€»è¾‘**ï¼š
1. ä¿å­˜çŠ¶æ€ï¼ˆåŠ¨ä½œæ‰§è¡Œå‰ï¼‰
2. æ‰§è¡ŒåŠ¨ä½œ
3. è®¡ç®—å¥–åŠ±ï¼ˆåŠ¨ä½œæ‰§è¡Œåï¼‰
4. æ›´æ–°çŠ¶æ€ä¸­çš„å‰¯ç‰Œå’Œå¼ƒç‰Œä¿¡æ¯

**å»ºè®®**ï¼š
- è€ƒè™‘ä¿å­˜ä¸¤ä¸ªçŠ¶æ€ï¼šåŠ¨ä½œæ‰§è¡Œå‰å’Œæ‰§è¡Œå
- æˆ–è€…ç¡®ä¿çŠ¶æ€æ›´æ–°é€»è¾‘æ­£ç¡®

### 5. **å›åˆæ•°æ›´æ–°æ—¶æœº**
**ä½ç½®**ï¼š`worker.py:396, 472, 479`
**é—®é¢˜**ï¼š`state.turn`çš„æ›´æ–°æ—¶æœºä¸æ˜ç¡®
**å½“å‰é€»è¾‘**ï¼š
- åŠ¨ä½œæ‰§è¡Œå‰ï¼š`game_turn_before_action = state.turn`
- åŠ¨ä½œæ‰§è¡Œåï¼š`game_turn_after_action = state.turn`
- ä½†ä¸ç¡®å®š`state.turn`ä½•æ—¶æ›´æ–°

**å»ºè®®**ï¼š
- æ£€æŸ¥Rustä»£ç ä¸­`state.turn`çš„æ›´æ–°é€»è¾‘
- ç¡®è®¤`turn`æ˜¯åœ¨åŠ¨ä½œæ‰§è¡Œæ—¶æ›´æ–°ï¼Œè¿˜æ˜¯åœ¨`next_turn()`æ—¶æ›´æ–°

### 6. **é”™è¯¯å¤„ç†**
**ä½ç½®**ï¼šå¤šå¤„`try-except`å—
**é—®é¢˜**ï¼šé”™è¯¯å¤„ç†å¯èƒ½è¿‡äºå®½æ¾ï¼Œå¯¼è‡´é—®é¢˜è¢«æ©ç›–
**å½“å‰é€»è¾‘**ï¼š
- çŠ¶æ€éªŒè¯é”™è¯¯ï¼šé™é»˜è·³è¿‡æˆ–ç»§ç»­
- å…¶ä»–é”™è¯¯ï¼šæ‰“å°æ—¥å¿—å¹¶ç»§ç»­æˆ–ä¸­æ–­

**å»ºè®®**ï¼š
- åŒºåˆ†å¯æ¢å¤é”™è¯¯å’Œä¸å¯æ¢å¤é”™è¯¯
- å¯¹äºä¸å¯æ¢å¤é”™è¯¯ï¼Œåº”è¯¥ä¸­æ–­æ¸¸æˆå¹¶è®°å½•

---

## âœ… æ­£ç¡®çš„é€»è¾‘

### 1. **æ¸¸æˆæµç¨‹**
```
åˆå§‹åŒ– â†’ å®šç¼º â†’ æ¸¸æˆä¸»å¾ªç¯ï¼š
  1. æ£€æŸ¥æ¸¸æˆç»“æŸ
  2. è·å–å½“å‰ç©å®¶
  3. æ£€æŸ¥ç©å®¶æ˜¯å¦ç¦»åœº
  4. æ‘¸ç‰Œ
  5. è·å–çŠ¶æ€å’ŒåŠ¨ä½œæ©ç 
  6. æ¨¡å‹æ¨ç†
  7. æ‰§è¡ŒåŠ¨ä½œ
  8. è®¡ç®—å¥–åŠ±
  9. æ›´æ–°çŠ¶æ€
```

### 2. **å¼ƒç‰Œè®°å½•**
- æŒ‰å›åˆè®°å½•ï¼š`player_discards_by_turn[player_id][turn] = [tiles]`
- æ˜¾ç¤ºæ—¶åªæ˜¾ç¤ºåˆ°å½“å‰å›åˆçš„å¼ƒç‰Œ

### 3. **æ¸¸æˆç»“æŸ**
- æµå±€ï¼š`remaining_tiles() == 0` æˆ– `is_last_tile == True`
- 3å®¶å’Œç‰Œï¼š`out_count >= 3`
- èƒ¡ç‰Œï¼š`result.get('type') == 'won'`

---

## ğŸ” éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥çš„åœ°æ–¹

### 1. **Rustå¼•æ“é€»è¾‘**
- `state.turn`ä½•æ—¶æ›´æ–°ï¼Ÿ
- ç©å®¶ç¦»åœºåï¼Œ`current_player`å¦‚ä½•åˆ‡æ¢ï¼Ÿ
- `next_turn()`æ–¹æ³•æ˜¯å¦å­˜åœ¨ï¼Ÿ

### 2. **åŠ¨ä½œæ‰§è¡Œé¡ºåº**
- æ‘¸ç‰Œ â†’ é€‰æ‹©åŠ¨ä½œ â†’ æ‰§è¡ŒåŠ¨ä½œçš„é¡ºåºæ˜¯å¦æ­£ç¡®ï¼Ÿ
- æ˜¯å¦éœ€è¦å¤„ç†å…¶ä»–ç©å®¶çš„å“åº”ï¼ˆç¢°ã€æ ã€èƒ¡ï¼‰ï¼Ÿ

### 3. **çŠ¶æ€ä¸€è‡´æ€§**
- ä¿å­˜çš„çŠ¶æ€å’Œè®¡ç®—å¥–åŠ±æ—¶ä½¿ç”¨çš„çŠ¶æ€æ˜¯å¦ä¸€è‡´ï¼Ÿ
- çŠ¶æ€æ›´æ–°æ˜¯å¦åŠæ—¶ï¼Ÿ

---

## ğŸ“ å»ºè®®çš„æ”¹è¿›

### 1. **ç»Ÿä¸€æ¸¸æˆç»“æŸå¤„ç†**
```python
def check_game_end(engine, state):
    """ç»Ÿä¸€æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶"""
    if engine.is_game_over():
        return True, 'engine_check'
    if engine.remaining_tiles() == 0:
        return True, 'wall_empty'
    if state.is_last_tile:
        return True, 'last_tile'
    if hasattr(state, 'out_count') and state.out_count >= 3:
        return True, 'three_players_out'
    return False, None
```

### 2. **æ”¹è¿›å·²ç¦»åœºç©å®¶å¤„ç†**
```python
if state.is_player_out(current_player):
    # æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
    if engine.is_game_over():
        break
    # å°è¯•åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç©å®¶ï¼ˆå¦‚æœå¼•æ“æ”¯æŒï¼‰
    # æˆ–è€…ä¾èµ–å¼•æ“è‡ªåŠ¨å¤„ç†
    continue
```

### 3. **æ·»åŠ çŠ¶æ€éªŒè¯**
```python
def validate_state_consistency(trajectory):
    """éªŒè¯è½¨è¿¹æ•°æ®çš„ä¸€è‡´æ€§"""
    assert len(trajectory['states']) == len(trajectory['actions'])
    assert len(trajectory['states']) == len(trajectory['rewards'])
    assert len(trajectory['states']) == len(trajectory['dones'])
    # ... æ›´å¤šéªŒè¯
```

---

## æ€»ç»“

### å·²ä¿®å¤ âœ…
1. æ‘¸ç‰ŒåçŠ¶æ€æ›´æ–°
2. å›åˆæ•°ä¸€è‡´æ€§
3. å¼ƒç‰Œæ˜¾ç¤ºé€»è¾‘

### éœ€è¦å…³æ³¨ âš ï¸
1. å·²ç¦»åœºç©å®¶å¤„ç†ï¼ˆå¯èƒ½å¯¼è‡´æ— é™å¾ªç¯ï¼‰
2. æ¸¸æˆç»“æŸæ¡ä»¶æ£€æŸ¥ï¼ˆå¤šå¤„é‡å¤ï¼‰
3. çŠ¶æ€å’Œå¥–åŠ±çš„ä¸€è‡´æ€§

### å»ºè®®æµ‹è¯• ğŸ§ª
1. æµ‹è¯•å·²ç¦»åœºç©å®¶åœºæ™¯
2. æµ‹è¯•æµå±€åœºæ™¯
3. æµ‹è¯•3å®¶å’Œç‰Œåœºæ™¯
4. æµ‹è¯•çŠ¶æ€å’Œå¥–åŠ±çš„ä¸€è‡´æ€§

