# 血战到底胡牌规则

开发顶级血战到底 AI，必须将规则逻辑完全映射为算法可理解的判定矩阵。血战到底（四川麻将）的核心在于"番数倍增"和"多轮结算"。

---

## 一、核心准则（AI 行动的前置条件）

在 Rust 模拟器中，如果不满足以下三点，必须通过 Action Masking 封闭胡牌动作：

### 1.1 缺一门

- **规则**：胡牌时，手牌中必须只有两门或一门牌
- **要求**：开局定缺的那一门必须打完
- **实现**：在 Action Masking 中强制检查

### 1.2 基本牌型

必须满足以下之一：
- **基本胡牌型**：$n \times (顺子/刻子) + 1 \times 将对$（通常为 4 个顺子/刻子 + 1 个对子）
- **七对牌型**：手牌由 7 个对子组成

### 1.3 不能吃牌

- **规则**：四川麻将严禁"吃"（ABC 顺子只能靠摸）
- **允许动作**：只能碰、杠

---

## 二、基础番型（倍率阶梯）

AI 的 Value Head 需要准确评估以下番型（通常以底分 $2^n$ 计算）：

| 番型 | 定义 | 番数（参考） | 代码实现 |
|------|------|--------------|----------|
| **平胡** | 基础胡牌，由顺子、刻子组成的杂牌 | $2^0 = 1$ | `WinType::Normal` |
| **对对胡** | 除了将牌，其余全是刻子（碰或杠） | $2^1 = 2$ | `WinType::AllTriplets` |
| **清一色** | 全副牌只有一门花色（万、筒、条选其一） | $2^2 = 4$ | `WinType::PureSuit` |
| **七对** | 不经过碰杠，手牌由 7 个对子组成 | $2^2 = 4$ | `WinType::SevenPairs` |
| **带幺九** | 每副牌（刻子/顺子）和将牌都包含 1 或 9 | $2^2 = 4$ | `WinType::AllTerminals` |
| **三色同顺** | 三种花色都有相同的顺子 | $2^2 = 4$ | `WinType::ThreeColorSequence` |
| **三色同刻** | 三种花色都有相同的刻子 | $2^2 = 4$ | `WinType::ThreeColorTriplet` |
| **四暗刻** | 四个刻子 + 1 个对子 | $2^2 = 4$ | `WinType::FourConcealedTriplets` |

---

## 三、进阶加番（高级博弈目标）

这些是顶级 AI 必须学会"造牌"的目标，也是番数暴涨的来源：

### 3.1 根（Gen）

- **定义**：手牌中包含 4 张相同的牌（无论是否开杠）
- **计算**：每有一个"根"，总番数 $\times 2$
- **示例**：
  - 1 个根：番数 $\times 2$
  - 2 个根：番数 $\times 4$
  - 3 个根：番数 $\times 8$

### 3.2 龙七对（进阶七对）

- **双龙七对**：
  - 定义：七对牌型中有 2 组四张相同的牌
  - 计算：七对(4) + 2根 = 16 番
  - 代码：`WinType::DragonSevenPairs`

- **三龙七对**：
  - 定义：七对牌型中有 3 组四张相同的牌
  - 计算：七对(4) + 3根 = 32 番
  - 代码：`WinType::DragonSevenPairs`（需额外统计根数）

### 3.3 清特殊（清一色组合）

| 番型 | 定义 | 计算 | 代码实现 |
|------|------|------|----------|
| **清对** | 清一色 + 对对胡 | $2^{2+1} = 8$ 番 | `WinType::PureAllTriplets` |
| **清七对** | 清一色 + 七对 | $2^{2+2} = 16$ 番 | `WinType::PureSevenPairs` |
| **清龙七对** | 清一色 + 龙七对 | $2^{2+3} = 32$ 番 | `WinType::PureDragonSevenPairs` |

### 3.4 其他组合

- **三色同顺 + 清一色**：理论上不可能（已实现但不会出现）
- **三色同刻 + 清一色**：理论上不可能（已实现但不会出现）

---

## 四、动作触发番（实时状态加成）

这些番型取决于胡牌的"那一瞬间"发生的动作：

| 动作 | 定义 | 番数加成 | 实现状态 |
|------|------|----------|----------|
| **自摸** | 自己摸牌胡牌 | +1 番 | 需在游戏状态中记录 |
| **杠上开花** | 杠牌后补牌胡牌 | +1 番 | 需在游戏状态中记录 |
| **杠上炮** | 杠牌后打出的牌被别人胡 | +1 番（点炮者包赔） | 需在游戏状态中记录 |
| **抢杠胡** | 别人在"弯杠"时，你胡他那张牌 | +1 番 | 需在游戏状态中记录 |
| **海底捞月** | 胡最后一张摸到的牌 | +1 番 | 需在游戏状态中记录 |

---

## 五、血战特有结算逻辑（AI 策略重难点）

### 5.1 刮风下雨（即时杠钱）

- **直杠/下雨（暗杠）**：
  - 立即收钱，不随胡牌结束而停止
  - 需要在游戏状态中实时结算

- **退税逻辑**：
  - 若杠牌者最后被查出是"没听牌"或"花猪"
  - 需将收到的杠钱退还

### 5.2 呼叫转移（杠上炮退税）

- **规则**：A 杠牌后打出一张牌给 B 胡
- **结算**：
  - A 不仅要给 B 杠上炮的钱
  - 还要把刚才那次杠收到的钱全部转给 B

### 5.3 过胡限制（重要）

- **规则**：若 AI 放弃了某个点炮胡
- **限制**：在它自己下次摸牌前，不能胡同一张牌或番数更低的点炮牌
- **实现**：需要在 Action Masking 中实现

### 5.4 查叫与查花猪（局末审判）

- **查花猪**：
  - 定义：牌打完还拿有定缺门的牌
  - 惩罚：赔给全场最大番

- **查大叫**：
  - 定义：没听牌的人
  - 惩罚：赔给听牌的人（按听牌者最高番数算）

---

## 六、Rust 逻辑实现建议

在 Rust 引擎中，建议将计算逻辑解耦为两个步骤：

### 6.1 PatternMatcher（牌型识别器）

识别基础牌型：
- 平胡、七对、清一色
- 对对胡、三色同顺、三色同刻
- 全带幺、四暗刻等

**当前实现**：`WinChecker::check_win()` 方法

### 6.2 MultiplierCalculator（倍率计算器）

统计"根"的数量、动作加成（杠开、杠炮）并应用倍率。

**建议实现结构**：

```rust
struct Settlement {
    base_pattern: u32,      // 基础番
    roots: u8,              // 根的数量
    is_gang_kai: bool,      // 是否杠开
    is_qing_yi_se: bool,    // 是否清一色
    is_zi_mo: bool,         // 是否自摸
    // ... 其他动作加成
}

impl Settlement {
    fn total_fans(&self) -> u32 {
        // 计算公式：基础番 * 2^(根数 + 额外动作番)
        let mut fans = self.base_pattern;
        
        // 根数倍率
        fans *= 2_u32.pow(self.roots as u32);
        
        // 动作加成
        if self.is_gang_kai { fans *= 2; }
        if self.is_zi_mo { fans *= 2; }
        
        fans
    }
}
```

---

## 七、当前实现状态

### 7.1 已实现的胡牌类型

✅ **基本类型**：
- 平胡（Normal）
- 七对（SevenPairs）
- 龙七对（DragonSevenPairs）

✅ **清一色系列**：
- 清一色（PureSuit）
- 清七对（PureSevenPairs）
- 清龙七对（PureDragonSevenPairs）

✅ **对对胡系列**：
- 对对胡（AllTriplets）
- 清对（PureAllTriplets）
- 四暗刻（FourConcealedTriplets）

✅ **特殊组合系列**：
- 三色同顺（ThreeColorSequence）
- 三色同刻（ThreeColorTriplet）
- 全带幺（AllTerminals）

### 7.2 待实现的功能

- [ ] 根（Gen）的统计和倍率计算
- [ ] 动作触发番（自摸、杠开、杠炮等）
- [ ] 刮风下雨结算逻辑
- [ ] 查叫与查花猪判定
- [ ] 过胡限制逻辑
- [ ] 完整的番数计算系统

---

## 八、番数计算公式

### 8.1 基础公式

```
总番数 = 基础番型 × 2^(根数) × 动作加成倍率
```

### 8.2 示例计算

**示例 1：清七对 + 1 个根 + 自摸**
- 基础番：清七对 = 16 番
- 根数：1 个 = ×2
- 自摸：+1 番 = ×2
- 总番数：16 × 2 × 2 = 64 番

**示例 2：龙七对（双龙）+ 杠上开花**
- 基础番：龙七对 = 16 番（七对 4 + 2 根 12）
- 杠上开花：+1 番 = ×2
- 总番数：16 × 2 = 32 番

---

## 九、实现优先级

### 高优先级（核心功能）
1. ✅ 基础胡牌型判定
2. ✅ 特殊牌型判定
3. ⏳ 根（Gen）的统计
4. ⏳ 基础番数计算

### 中优先级（游戏逻辑）
5. ⏳ 动作触发番（自摸、杠开等）
6. ⏳ 刮风下雨结算
7. ⏳ 查叫与查花猪

### 低优先级（优化功能）
8. ⏳ 过胡限制
9. ⏳ 呼叫转移（杠上炮退税）
10. ⏳ 完整的结算系统

---

## 十、参考实现

当前 Rust 实现位置：
- **胡牌判定**：`rust/src/tile/win_check.rs`
- **牌型枚举**：`WinType` 枚举
- **判定器**：`WinChecker` 结构体

测试覆盖：
- 11 个胡牌判定测试用例
- 覆盖所有已实现的胡牌类型
